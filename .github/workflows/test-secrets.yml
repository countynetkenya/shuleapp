name: "Verify repo secrets (OPENAI_API_KEY & GH_TOKEN)"

on:
  workflow_dispatch:

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check GH token — authenticate user
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          status=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $GH_TOKEN" https://api.github.com/user)
          if [ "$status" -eq 200 ]; then
            echo "GH_TOKEN: ok (can authenticate to GitHub API)"
          else
            echo "GH_TOKEN: failed (status $status)"
            exit 1
          fi

      - name: Check GH token — repo access
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          REPO: "${{ github.repository }}"
        run: |
          status=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$REPO")
          if [ "$status" -eq 200 ]; then
            echo "GH_TOKEN: has access to $REPO"
          else
            echo "GH_TOKEN: cannot access $REPO (status $status)"
            exit 1
          fi

      - name: Check OPENAI key — models endpoint
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          status=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $OPENAI_API_KEY" https://api.openai.com/v1/models)
          if [ "$status" -ge 200 ] && [ "$status" -lt 300 ]; then
            echo "OPENAI_API_KEY: ok (models endpoint reachable)"
          else
            echo "OPENAI_API_KEY: failed (status $status)"
            exit 1
          fi
